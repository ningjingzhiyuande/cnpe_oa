$(function(){function a(a,t){var e=0,d=$(".start_at_half_day_"+a+":radio:checked").val(),r=$(".end_at_half_day_"+a+":radio:checked").val();return e+=t?"1"==d?1:.5:"1"==r?.5:1}function t(a,t){var e,d=0,r=0,_=0;for(e=0;t>e;e++)a.setDate(a.getDate()+1),day=a.getFullYear()+"/"+(a.getMonth()+1)+"/"+a.getDate(),console.log(a),jQuery.inArray(day,rest_days)>=0&&(d+=1),jQuery.inArray(day,work_days)>=0&&(r+=1),(0==new Date(day).getDay()||6==new Date(day).getDay())&&(_+=1);return console.log(d+_),console.log(r),[d+_,r]}function e(a){return day=a.format("yyyy/mm/dd"),0==new Date(day).getDay()||6==new Date(day).getDay()?jQuery.inArray(day,work_days)>=0?!0:!1:jQuery.inArray(day,rest_days)>=0?!1:!0}function d(t){var d=0,r=$(".start_at_"+t).val(),_=$(".end_at_"+t).val();if(""!=r&&""!=_){var s=new Date(new Date(r).format("yyyy/mm/dd")),n=new Date(new Date(_).format("yyyy/mm/dd")),l=n-s,o=Math.floor(l/1e3/60/60/24);console.log("vdaydiff:"+o);for(var i=0;o>=i;i++){if(console.log("work_flag:"+e(s)),console.log("start_at:"+s),e(s)){if(0==i){d+=a(t,!0),s.setDate(s.getDate()+1);continue}if(i==o){d+=a(t,!1);break}d+=1}s.setDate(s.getDate()+1)}}return d}function r(a){if(!is_edit){var t=($(a).attr("data-id"),k(a));return date=new Date(t),[date.format("yyyy/mm/dd")]}}function _(){array=rest_days.concat(work_days),jQuery.map(array,function(a){return""!=a?a:void 0})}function s(a){var t=$(".start_at_"+a).val(),e=$(".end_at_"+a).val();if(""!=t&&""!=e){var r=d(a);"0"==a&&parseFloat(r)>parseFloat(total_nj_day)&&alert("\u60a8\u4e00\u5171\u6709"+total_nj_day+"\u5929\u5e74\u5047\uff0c\u8bf7\u91cd\u65b0\u9009\u62e9"),"1"==a&&parseFloat(r)>parseFloat(total_sj_day)&&alert("\u4e00\u5e74\u4e4b\u5185\u53ea\u80fd\u8bf714\u5929\u4e8b\u5047\uff0c\u60a8\u8fd8\u80fd\u8bf7"+total_sj_day+"\u5929\uff0c\u8bf7\u91cd\u65b0\u9009\u62e9"),"7"==a&&parseFloat(r)>parseFloat(total_sangj_day)&&alert("\u4e00\u5e74\u4e4b\u5185\u53ea\u80fd\u8bf73\u5929\u4e27\u5047\uff0c\u60a8\u8fd8\u80fd\u8bf7"+total_sangj_day+"\u5929\uff0c\u8bf7\u91cd\u65b0\u9009\u62e9"),console.log("\u8ba1\u7b97"),$("#select_days_"+a).val(r)}}function n(a,e){return work_an_rest_day=t(a,e),rest_day=work_an_rest_day[0],parseInt(rest_day)>=1&&n(a,rest_day),a}function l(a){start_at=$(".start_at_"+a).val(),""!=start_at&&("1"==user_gender?(date=new Date(start_at),date.setDate(date.getDate()+29),$(".end_at_"+a).val(date.format("yyyy/mm/dd")),$("#select_days_"+a).val(30)):(date=new Date(start_at),date.setDate(date.getDate()+97),end_at=n(date,30),$(".end_at_"+a).val(end_at.format("yyyy/mm/dd")),$("#select_days_"+a).val(128)))}function o(a,t){start_at=$(".start_at_"+a).val(),""!=start_at&&(date=new Date(start_at),date.setDate(date.getDate()+t-1),$(".end_at_"+a).val(date.format("yyyy/mm/dd")),$("#select_days_"+a).val(t))}function i(a,t){start_at=$(".start_at_"+a).val(),""!=start_at&&(date=new Date(start_at),end_at=n(date,t-1),$(".end_at_"+a).val(end_at.format("yyyy/mm/dd")),$("#select_days_"+a).val(10))}function y(a){var t=$("#start_at_"+a).val(),e=$("#end_at_"+a).val();if(""!=t&&""!=e){var d=new Date(new Date(t).format("yyyy/mm/dd")),r=new Date(new Date(e).format("yyyy/mm/dd")),_=r-d,s=Math.floor(_/1e3/60/60/24);$("#select_days_"+a).val(s+1)}}function c(a){var t=$("#start_at_"+a).val(),e=$("#end_at_"+a).val(),d="1"==$(".start_at_half_day_"+a+":radio:checked").val()?" 12:00":" 18:00",r="1"==$(".end_at_half_day_"+a+":radio:checked").val()?" 12:00":" 18:00",_=new Date(new Date(t).format("yyyy/mm/dd")+d),s=new Date(new Date(e).format("yyyy/mm/dd")+r);""!=_&&""!=s&&$(".leave_kind:checkbox:checked").each(function(){var t=$(this).attr("data-id");if(a!=t){var e=$("#start_at_"+t).val(),d=$("#end_at_"+t).val(),r="1"==$(".start_at_half_day_"+t+":radio:checked").val()?" 12:00":" 18:00",s="1"==$(".end_at_half_day_"+t+":radio:checked").val()?" 12:00":" 18:00",n=new Date(new Date(e).format("yyyy/mm/dd")+r),l=new Date(new Date(d).format("yyyy/mm/dd")+s),l=new Date(d+s);_>=n&&l>=_&&(alert("\u60a8\u9009\u62e9\u7684\u65e5\u671f\u548c\u5176\u4ed6\u8bf7\u5047\u7c7b\u578b\u91cd\u590d\uff0c\u8bf7\u68c0\u67e5!"),$("#start_at_"+a).val(""))}})}function u(a){var t=$("#start_at_"+a).val(),e=$("#end_at_"+a).val(),d="1"==$(".start_at_half_day_"+a+":radio:checked").val()?" 12:00":" 18:00",r="1"==$(".end_at_half_day_"+a+":radio:checked").val()?" 12:00":" 18:00",_=new Date(new Date(t).format("yyyy/mm/dd")+d),s=new Date(new Date(e).format("yyyy/mm/dd")+r);""!=_&&""!=s&&leave_ids.forEach(function(t){if(a!=t){var e=$("#start_at_"+t).val(),d=$("#end_at_"+t).val(),r="1"==$(".start_at_half_day_"+t+":radio:checked").val()?" 12:00":" 18:00",s="1"==$(".end_at_half_day_"+t+":radio:checked").val()?" 12:00":" 18:00",n=new Date(new Date(e).format("yyyy/mm/dd")+r);console.log(l>=_);var l=new Date(new Date(d).format("yyyy/mm/dd")+s);_>=n&&l>=_&&(alert("\u60a8\u9009\u62e9\u7684\u65e5\u671f\u548c\u5176\u4ed6\u8bf7\u5047\u7c7b\u578b\u91cd\u590d\uff0c\u8bf7\u68c0\u67e5"),$("#start_at_"+a).val(""))}})}function v(){switch(data_id=$(this).attr("data-id")){case"0":s(data_id);break;case"1":s(data_id);break;case"2":s(data_id);break;case"3":s(data_id);break;case"4":l(data_id,!0);break;case"5":y(data_id);break;case"6":i(data_id,total_hj_day);break;case"7":s(data_id);break;case"8":o(data_id,20);break;case"9":o(data_id,20);break;case"10":o(data_id,30);break;case"11":s(data_id);break;case"12":s(data_id)}is_edit?u(data_id):c(data_id),f()}function f(){var a=0;$(".choose_days_per_leave").each(function(){value=$(this).val(),""!=value&&(a+=parseInt(value))}),choose_total_days=a,3>a?$(".second_auddit").hide():$(".second_auddit").show()}function h(a){"0"==a&&$("#select_days_0").rules("add",{required:!0,cal_nj_days:!0,messages:{required:"\u4e00\u5171\u53ef\u4ee5\u8bf7"+total_nj_day+"\u5929"}})}function m(a){$("#select_days_"+a).rules("add",{required:!0,cal_shij_days:!0,messages:{required:"\u4e00\u5e74\u4e4b\u5185\u53ea\u80fd\u8bf714\u5929\u4e8b\u5047\uff0c\u60a8\u5df2\u7ecf\u8bf7\u4e86"+total_sj_day+"\uff0c\u8bf7\u91cd\u65b0\u9009\u62e9"}})}function D(a){$("#select_days_"+a).rules("add",{required:!0,cal_sangj_days:!0,messages:{required:"\u4e00\u5e74\u4e4b\u5185\u53ea\u80fd\u8bf73\u5929\u4e27\u5047\uff0c\u60a8\u5df2\u7ecf\u8bf7\u4e86"+total_sangj_day+"\uff0c\u8bf7\u91cd\u65b0\u9009\u62e9"}})}function D(a){$("#select_days_"+a).rules("add",{required:!0,cal_sangj_days:!0,messages:{required:"\u4e00\u5e74\u4e4b\u5185\u53ea\u80fd\u8bf73\u5929\u4e27\u5047\uff0c\u60a8\u5df2\u7ecf\u8bf7\u4e86"+total_sangj_day+"\uff0c\u8bf7\u91cd\u65b0\u9009\u62e9"}})}$(".second_auddit").hide(),$(".leave_kind").click(function(){data_id=$(this).attr("data-id"),is_annual||"0"!=data_id||(alert("\u6309\u7167\u89c4\u5b9a\uff1a\u8bf7\u4e8b\u5047\u7d2f\u8ba114\u5929(\u542b),\u6ca1\u6709\u5e74\u4f11\u5047\uff0c\u6216\u8005\u5de5\u4f5c\u6ee11-10\u5e74\uff0c\u75c5\u5047>=2\u4e2a\u6708\u7684\u6ca1\u6709\u5e74\u4f11\u5047\uff0c\u5de5\u4f5c\u6ee110-20\u5e74\uff0c\u75c5\u5047>=3\u4e2a\u6708\u7684\u6ca1\u6709\u5e74\u4f11\u5047\uff0c\u5de5\u4f5c\u6ee120\u5e74\u4ee5\u4e0a\uff0c\u75c5\u5047>=4\u4e2a\u6708\u7684\u6ca1\u6709\u5e74\u4f11\u5047"),$(this).prop("checked",!1)),"0"==data_id&&0>=total_nj_day&&(alert("\u60a8\u5df2\u7ecf\u6ca1\u6709\u5e74\u5047\u4e86,\u5982\u679c\u6709\u95ee\u9898\u8bf7\u8054\u7cfb\u7ba1\u7406\u5458\u3002"),$(this).prop("checked",!1)),10!=total_hj_day&&"4"==data_id&&(alert("\u6309\u7167\u89c4\u5b9a\uff1a\u5fc5\u987b\u665a\u5a5a\u665a\u80b2\u624d\u80fd\u4f11\u542b\u5956\u52b1\u7684\u5047\u671f"),$(this).prop("checked",!1)),0==total_hj_day&&"6"==data_id&&(alert("\u8bf7\u627e\u7ba1\u7406\u5458\u8bbe\u7f6e\u60a8\u7684\u51fa\u751f\u65e5\u671f"),$(this).prop("checked",!1)),$(this).prop("checked")?$("li.kind_"+data_id).show():($("li.kind_"+data_id).hide(),$("#start_at_"+data_id).val(""),$("#end_at_"+data_id).val(""),$("#select_days_"+data_id).val(""),f())}),$(".half_day_radio").change(function(){var a=$(this).attr("data-id");s(a)}),$(".datetimepicker1").click(function(){WdatePicker({firstDayOfWeek:0,minDate:r(this),isShowClear:!1,readOnly:!0,autoPickDate:!0,errDealMode:2,dateFmt:"yyyy/MM/dd",specialDates:_(),onpicked:v})});var k=function(a){var t=[];return value=$(a).attr("data-value"),data_id=$(a).attr("data-id"),$(".leave_kind:checkbox:checked").each(function(){var a=$(this).attr("data-value"),e=$(this).attr("data-id");data_id!=e&&(a!=value&&""!=$("#start_at_"+e).val()&&t.push($("#start_at_"+e).val()),a!=value&&""!=$(".end_at_"+e).val()&&t.push($(".end_at_"+e).val()))}),0==t.length?new Date((new Date).setDate((new Date).getDate()-1)):(console.log(t.sort()),new Date(t.sort()[t.length-1]))};jQuery.validator.addMethod("cal_nj_days",function(a,t){return this.optional(t)||parseFloat(a)<=parseFloat(total_nj_day)},"\u60a8\u5e74\u5047\u4e00\u5171"+total_nj_day+"\u5929,\u8bf7\u91cd\u65b0\u9009\u62e9"),jQuery.validator.addMethod("cal_shij_days",function(a,t){return this.optional(t)||parseFloat(a)<=parseFloat(total_sj_day)},"\u4e00\u5e74\u4e4b\u5185\u53ea\u80fd\u8bf714\u5929\u4e8b\u5047\uff0c\u60a8\u53ea\u80fd\u8bf7"+total_sj_day+"\u5929\uff0c\u8bf7\u91cd\u65b0\u9009\u62e9"),jQuery.validator.addMethod("cal_sangj_days",function(a,t){return this.optional(t)||parseFloat(a)<=parseFloat(total_sangj_day)},"\u4e00\u5e74\u4e4b\u5185\u53ea\u80fd\u8bf73\u5929\u4e27\u5047\uff0c\u60a8\u53ea\u80fd\u8bf7"+total_sangj_day+"\u5929\uff0c\u8bf7\u91cd\u65b0\u9009\u62e9"),jQuery.validator.addMethod("cal_total_per_days",function(){return choose_total_days>2},"\u8bf7\u5047\u5929\u6570\u8d85\u8fc7\u4e24\u5929\u5fc5\u987b\u8981\u9886\u5bfc\u5ba1\u6279\uff0c\u8bf7\u9009\u62e9"),jQuery.validator.addMethod("must_more_zero",function(a,t){return this.optional(t)||parseFloat(a)>parseFloat(0)},"\u6570\u636e\u6709\u9519\u8bef\uff0c\u8bf7\u91cd\u65b0\u68c0\u67e5"),$(".new_leave").on("submit",function(){$(".leave_kind:checkbox:checked").each(function(){var a=$(this).attr("data-id");switch(a){case"0":h(a);break;case"1":m(a);break;case"7":D(a)}$("#start_at_"+a).rules("add",{required:!0,messages:{required:"\u8bf7\u586b\u5199\u8d77\u59cb\u65e5\u671f"}}),$("#end_at_"+a).rules("add",{required:!0,messages:{required:"\u8bf7\u586b\u5199\u7ed3\u675f\u65e5\u671f"}}),$("#select_days_"+a).rules("add",{required:!0,must_more_zero:!0,messages:{required:"\u65e5\u671f"}}),$("#leave_reporter2_id").rules("add",{required:!0,cal_total_per_days:!0,messages:{required:"\u8bf7\u5047\u5929\u6570\u8d85\u8fc7\u4e24\u5929\u5fc5\u987b\u8981\u9886\u5bfc\u5ba1\u6279"}})})}),$(".new_leave").validate({errorElement:"b",rules:{"leave[title]":"required","leave[leave_details_attributes][kind][]":"required"},messages:{"leave[title]":"\u4e0d\u80fd\u4e3a\u7a7a","leave[leave_details_attributes][kind][]":"\u9009\u62e9\u8bf7\u5047\u7c7b\u578b"}})});