$(document).ready(function(){function t(t){return date=new Date(t),hour=Math.abs(18-date.getHours()),1>hour?0:7>hour?.5:1}function a(t,a){for(var e=0,d=0,r=0,n=0;a>n;n++){var s=new Date(t.getFullYear()+"/"+(t.getMonth()+1)+"/"+(t.getDate()+n)+" 00:00");console.log("\u8ba1\u7b97days:"+s),rest_days.indexOf(s.format("yyyy/mm/dd"))>=0&&(e+=1),work_days.indexOf(s.format("yyyy/mm/dd"))>=0&&(d+=1),(0==s.getDay()||6==s.getDay())&&(r+=1)}return e+r-d}function e(e,d){e=new Date(e),d=new Date(d),s_hour=t(e),e_hour=Math.abs(t(d)-1);var r=new Date(e.getFullYear()+"/"+(e.getMonth()+1)+"/"+(e.getDate()+1)+" 00:00"),n=new Date(d.getFullYear()+"/"+(d.getMonth()+1)+"/"+d.getDate()+" 00:00");return diff=n-r,vdaysdiff=Math.floor(diff/1e3/60/60/24),rest_work_day=a(r,vdaysdiff),vdaysdiff+s_hour+e_hour-rest_work_day}function d(t,a){var e=a.attr("data-id"),d=$(a).attr("data-value"),r=s(e);"start_at_"+e==d&&this.setOptions({allowTimes:["09:00","12:00","13:00"],defaultTime:"09:00",minDate:new Date(r),maxDate:$(".end_at_"+e).val()?new Date($(".end_at_"+e).val()):!1}),"end_at_"+e==d&&this.setOptions({allowTimes:["12:00","13:00","18:00"],defaultTime:"18:00",minDate:new Date($(".start_at_"+e).val()?$(".start_at_"+e).val():r)})}function r(t){var a=$.datepicker.noWeekends(t);if(a[0])return n(t);for(flag=n(t)[0],i=0;i<work_days.length;i++)if(month=parseInt(work_days[i].split("/")[1]),day=parseInt(work_days[i].split("/")[2]),t.getMonth()==month-1&&t.getDate()==day&&flag)return[!0,""];return[!1,""]}function n(t){for(i=0;i<rest_days.length;i++)if(month=parseInt(rest_days[i].split("/")[1]),day=parseInt(rest_days[i].split("/")[2]),t.getMonth()==month-1&&t.getDate()==day)return[!1,""];return[!0,""]}$(".leave_kind").click(function(){data_id=$(this).attr("data-id"),$(this).prop("checked")?$("li.kind_"+data_id).show():$("li.kind_"+data_id).hide()}),$(".datetimepicker1").datetimepicker({format:"Y/m/d  H:i",firstDay:0,lang:"ch",closeOnDateSelect:!0,defaultTime:"09:00",onShow:d,beforeShowDay:r,onClose:function(t,a){data_id=a.attr("data-id"),start_at=$(".start_at_"+data_id).val(),end_at=$(".end_at_"+data_id).val(),""!=start_at&&""!=end_at&&(days=e(start_at,end_at),"0"==data_id&&parseFloat(days)>parseFloat(total_nj_day)&&alert("\u60a8\u4e00\u5171\u6709"+total_nj_day+"\u5929\u5e74\u5047\uff0c\u8bf7\u91cd\u65b0\u9009\u62e9"),$("#select_days_"+data_id).val(days))}});var s=function(t){var a=[];return console.log(t),$(".leave_kind:checkbox:checked").each(function(){var e=$(this).attr("data-id");console.log($("#start_at_"+e).val()),e!=t&&""!=$("#start_at_"+e).val()&&a.push($("#start_at_"+e).val()),e!=t&&""!=$(".end_at_"+e).val()&&a.push($(".end_at_"+e).val())}),0==a.length?new Date:(console.log(a.sort()),new Date(a.sort()[a.length-1]))};jQuery.validator.addMethod("cal_nj_days",function(t,a){return console.log("value:"+t),console.log(this.optional(a)||parseFloat(t)<=parseFloat(total_nj_day)),this.optional(a)||parseFloat(t)<=parseFloat(total_nj_day)},"\u60a8\u7684\u5e74\u5047\u4e00\u5171"+total_nj_day+"\u5929,\u8bf7\u91cd\u65b0\u9009\u62e9"),$(".new_leave").on("submit",function(){$(".leave_kind:checkbox:checked").each(function(){var t=$(this).attr("data-id");"0"==t&&$("#select_days_"+data_id).rules("add",{required:!0,cal_nj_days:!0,messages:{required:"\u4e00\u5171\u53ef\u4ee5\u8bf7"+total_nj_day}}),$("#start_at_"+t).rules("add",{required:!0,messages:{required:"\u8bf7\u586b\u5199\u8bf7\u5047\u8d77\u59cb\u65e5\u671f"}}),$("#end_at_"+t).rules("add",{required:!0,messages:{required:"\u8bf7\u586b\u5199\u8bf7\u5047\u7ed3\u675f\u65e5\u671f"}})})}),$(".new_leave").validate({errorElement:"b",rules:{"leave[title]":"required","leave[leave_details_attributes][kind][]":"required"},messages:{"leave[title]":"\u4e0d\u80fd\u4e3a\u7a7a","leave[leave_details_attributes][kind][]":"\u9009\u62e9\u8bf7\u5047\u7c7b\u578b"}})});